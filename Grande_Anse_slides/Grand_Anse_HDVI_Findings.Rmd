---
title: "Grand Anse, Haiti - Saftey Net Program"
author: "Noimot Bakare"
date: "3/8/2021"
output: beamer_presentation
---

```{r Libraries, include=FALSE}
library(rtrim)
library(Hmisc)
library(csv)
library(foreign)
library(stringr)
library(psych)
library(collapse)
##########################Summary Stats#############################
library(data.table)
library(stats)
library(DataExplorer)
library(reporttools)
library(reshape)
library(freqdist)
library(knitr)
library(rmarkdown)
library(tinytex)
library(markdown)
library(summarytools)
library(kableExtra)
library(haven)
library(survey)
library(srvyr)
library(ggplot2)

#########################Graphics and visualization#################
# library(plotly)
# library(gganimate)
# library(maptools)
# library(maps)
# library(ggmap)   
##########################Data Wrangling##############################
library(stringr)
library(tidyverse)
#library(tidyr)
#library(plyr)
library(dplyr)
library(devtools) 
library(pastecs)
library(janitor)
#########################3
library(AER)
library(sandwich)
library(readxl)
library(foreign)
library(apa)
# options(scipen=999)

###calling libraries for graphs
#library('ggplot2')
library('scales')     # for scale_y_continuous(label = percent)
library('ggthemes')   # for scale_fill_few('medium')
#library(viridis)  #Purple green yellow collor palett
library('ztable')     # format tables for reporting
library(stargazer)
library(texreg)
library(fastDummies)
library(tidyverse)
library(haven)
library(gt)
library(janitor)
library(FSA)

# grand_anse_dataforDRM_nb <- read.csv("~/Dropbox/grand_anse_data_nb.csv")
# grand_anse_dataforDRM_nb <- read_excel("../data/grand_anse_data_nb.xlsx")
## I wrote a csv file with the cleaned-up dataframe (Gran_Anse) below, to avoid having to read from the original data each time.

```

##  HDVI - Haiti's Deprivation and Vulnerability Index
**HDVI**

- Consists of 20 indicators of living conditions
- Across 7 dimensions of vulnerability
- Is a  a number [0 <= HDVI <= 1]
- The higher the HDVI the higher the household deprivation



##  Household Classification
**Households are classified into 4 categories**

- More Deprived
- Mid Deprived
- Less Deprived
- Not Deprived


##  Objective:
> Of the 7 vulnerabiilty measures, food vulnerability is the variable of interest, because food consumption is a good predictor of a househod well-being.

> This analysis is the first stage in identifying the most vulnerable population in Grande Anse, Haiti.

## Data:
**Households were asked 3 series of questions regarding food security over the 4 weeks prior to the data collection/ survey interview period.**

1. Absence of Food - If HH members experienced absence of food due to lack of resources.

2. Hunger - If HH members went to bed hungry because they could not eat sufficiently.

3. Restricted Consumption - If HH members were forced to fast during an entire day because there was not enough food.

**Possible Responses:**

1. never
2. sometimes
3. Often


## Variables of Interest:

In the 4 weeks prior to the interview date:

**Absence of Food**
- cat_hh_no_food_at_all1
- cat_hh_no_food_at_all2
- cat_hh_no_food_at_all3

**Forced to fast**
- cat_hh_day_no_food1,
- cat_hh_day_no_food2
- cat_hh_day_no_food3

**Went to bed hungry**
- cat_hh_bed_hungry1
- cat_hh_bed_hungry2
- cat_hh_bed_hungry3



```{r Data , include=FALSE}



# #Pulling in social registry data 
# grand_anse <- read_excel("Dropbox/WB_GFDRR_STC/Grand_anse/grand_anse_dataforDRM_nb.xlsx")
# 

# grand_anse_dataforDRM_nb <- read_excel("Dropbox/WB_GFDRR_STC/Grand_anse/grand_anse_data_nb.xlsx")



# Gran_Anse <- grand_anse_dataforDRM_nb %>%
#   select(commune, urban, hhsize, relation_to_hhh, haitisdeprivationsandvulnerabili, mi_vulnerable, moins_vulnerable, non_vulnerable, plus_vulnerable, 
#          cat_hh_no_food_at_all1,                      
#          cat_hh_no_food_at_all2,
#          cat_hh_no_food_at_all3,
#          cat_hh_day_no_food1,     
#          cat_hh_day_no_food2,
#          cat_hh_day_no_food3,
#          cat_hh_bed_hungry1,
#          cat_hh_bed_hungry2, 
#          cat_hh_bed_hungry3)

# Made new csv with Gran_Anse dataframe
# write_csv(Gran_Anse, "../data/Gran_Anse.csv")
Gran_Anse <- read_csv("../data/Gran_Anse.csv")

Gran_Anse_1 <- Gran_Anse %>%
  na.omit(Gran_Anse) %>%
  rename(c("HDVI" = "haitisdeprivationsandvulnerabili", "no_vulnerability" = "non_vulnerable", "less_vulnerability" = "moins_vulnerable",
           "mid_vulnerability" = "mi_vulnerable", "more_vulnerability" = "plus_vulnerable")) %>%
  as.data.frame()

#Absence of Food 
Gran_Anse_1$cat_hh_no_food_at_all1<- as.factor(Gran_Anse_1$cat_hh_no_food_at_all1)

Gran_Anse_1$cat_hh_no_food_at_all2<- as.factor(Gran_Anse_1$cat_hh_no_food_at_all2)

Gran_Anse_1$cat_hh_no_food_at_all3<- as.factor(Gran_Anse_1$cat_hh_no_food_at_all3)


#FAST
Gran_Anse_1$cat_hh_day_no_food1<- as.factor(Gran_Anse_1$cat_hh_day_no_food1)

Gran_Anse_1$cat_hh_day_no_food2<- as.factor(Gran_Anse_1$cat_hh_day_no_food2)

Gran_Anse_1$cat_hh_day_no_food3<- as.factor(Gran_Anse_1$cat_hh_day_no_food3)

#Hunger
Gran_Anse_1$cat_hh_bed_hungry1<- as.factor(Gran_Anse_1$cat_hh_bed_hungry1)

Gran_Anse_1$cat_hh_bed_hungry2<- as.factor(Gran_Anse_1$cat_hh_bed_hungry2)

Gran_Anse_1$cat_hh_bed_hungry3<- as.factor(Gran_Anse_1$cat_hh_bed_hungry3)



#Mutating a single column 

Gran_Anse_1 <- Gran_Anse_1 %>%
  mutate(Bed_Hungery = case_when(
    cat_hh_bed_hungry1 %in% "1" ~ "Never",
    cat_hh_bed_hungry2 %in% "1" ~ "Sometimes",
    cat_hh_bed_hungry3 %in% "1" ~ "Often"
  ))

Gran_Anse_1 <- Gran_Anse_1 %>%
  mutate(Bed_Hungery_depth = case_when(
    cat_hh_bed_hungry1 %in% "1" ~ "1",
    cat_hh_bed_hungry2 %in% "1" ~ "2",
    cat_hh_bed_hungry3 %in% "1" ~ "3"
  )) 



Gran_Anse_1 <- Gran_Anse_1 %>%
  mutate(Absence_Food = case_when(
    cat_hh_no_food_at_all1 %in% "1" ~ "Never",
    cat_hh_no_food_at_all2 %in% "1" ~ "Sometimes",
    cat_hh_no_food_at_all3 %in% "1" ~ "Often"
  ))

Gran_Anse_1 <- Gran_Anse_1 %>%
  mutate(Absence_Food_depth = case_when(
    cat_hh_no_food_at_all1 %in% "1" ~ "1",
    cat_hh_no_food_at_all2 %in% "1" ~ "2",
    cat_hh_no_food_at_all3 %in% "1" ~ "3"
  )) 


Gran_Anse_1 <- Gran_Anse_1 %>%
  mutate(Restricted_Food = case_when(
    cat_hh_day_no_food1 %in% "1" ~ "Never",
    cat_hh_day_no_food2 %in% "1" ~ "Sometimes",
    cat_hh_day_no_food3 %in% "1" ~ "Often"
  ))

Gran_Anse_1 <- Gran_Anse_1 %>%
  mutate(Restricted_Food_depth = case_when(
    cat_hh_day_no_food1 %in% "1" ~ "1",
    cat_hh_day_no_food2 %in% "1" ~ "2",
    cat_hh_day_no_food3 %in% "1" ~ "3"
  )) 


```

<!-- ## Summary Statistics -->

<!-- ```{r Summary Stat, echo=FALSE} -->

<!-- stargazer(Gran_Anse_1 , type ='text', title="Summary Statistics", align=TRUE, column.sep.width = ".8pt", single.row = TRUE) -->

<!-- #stargazer(Gran_Anse_1) -->
<!-- # knitr::kable(Gran_Anse_1, caption = "Summary Statistics") -->
<!-- ``` -->



<!-- ## Summary Statistics -->

<!-- ```{r Summary Stat2, echo=FALSE} -->

<!-- stargazer(Gran_Anse_1) -->

<!-- #stargazer(Gran_Anse_1) -->
<!-- # knitr::kable(Gran_Anse_1, caption = "Summary Statistics") -->
<!-- ``` -->



<!-- ```{r Summary Stat3, echo=FALSE} -->

<!-- kable(Gran_Anse_1) -->

<!-- #stargazer(Gran_Anse_1) -->
<!-- # knitr::kable(Gran_Anse_1, caption = "Summary Statistics") -->
<!-- ``` -->
<!-- ```{r Plots, eval=FALSE, include=FALSE} -->
<!-- # #Absence of Food -->
<!-- # -->
<!-- # cdplot(cat_hh_no_food_at_all1 ~ HDVI, Gran_Anse_1, col=c("cornflowerblue", "orange"), main="Households that never experienced absence of food") -->
<!-- # -->

<!-- ``` -->

## Absence of food - Often

```{r Plots1, echo=FALSE}
cdplot(cat_hh_no_food_at_all3 ~ HDVI, Gran_Anse_1, col=c("cornflowerblue", "orange"), main="Households that often experienced absence of food")

```

## Absence of food - Sometimes

```{r Plots2, echo=FALSE}
cdplot(cat_hh_no_food_at_all2 ~ HDVI, Gran_Anse_1, col=c("cornflowerblue", "orange"), main="Households that sometimes experienced absence of food")

```

## Forced to Fast - Often

```{r Plots3, echo=FALSE}
cdplot(cat_hh_day_no_food3 ~ HDVI, Gran_Anse_1, col= c("lightblue","darkblue"), main="Households that were often forced to fast due to lack of food")

```


## Forced to Fast - Sometimes

```{r Plots4, echo=FALSE}

cdplot(cat_hh_day_no_food2 ~ HDVI, Gran_Anse_1,  col= c("lightblue","darkblue"), main="Households that were sometimes forced to fast due to lack of food")

```

## Went to bed Hungry - Often

```{r Plots5, echo=FALSE}


cdplot(cat_hh_bed_hungry3 ~ HDVI, Gran_Anse_1, col= c("lightblue","darkblue"), main="Household that often go to bed hungry")

```


## Went to bed Hungry - Sometimes
```{r Plots6, echo=FALSE}

cdplot(cat_hh_bed_hungry2 ~ HDVI, Gran_Anse_1, col= c("lightblue","darkblue"), main="Household that sometimes go to bed hungry")
```


## Population distribution - Gone to bed hungry
```{r Plots7, echo=FALSE}




ggplot(Gran_Anse_1, aes(x = HDVI)) +
  geom_density(aes(group = Bed_Hungery,
                   colour = Bed_Hungery,
                   fill = Bed_Hungery),
               alpha = 0.2) +
  theme_minimal()


```

## Population distribution - Absence of Food
```{r Plots 8, echo=FALSE}



ggplot(Gran_Anse_1, aes(x = HDVI)) +
  geom_density(aes(group = Absence_Food,
                   colour = Absence_Food,
                   fill = Absence_Food),
               alpha = 0.2) +
  theme_minimal()


```


## Population distribution - Restricted Consumption
```{r Plots 9, echo=FALSE}


ggplot(Gran_Anse_1, aes(x = HDVI)) +
  geom_density(aes(group = Restricted_Food,
                   colour = Restricted_Food,
                   fill = Restricted_Food),
               alpha = 0.2) +
  theme_minimal()

```


## Population distribution - Restricted Consumption
```{r Plots 10, echo=FALSE}
library(ggplot2)
library(grid)
library(gridExtra)

##Import data
# df<- read.csv("D:\\R\\SF_Question.csv")

##Draw individual plots
#the lower panel
p1<- ggplot(Gran_Anse_1, aes(HDVI, Restricted_Food)) + geom_line() + scale_y_reverse() + labs(x="AGE") + scale_x_continuous(breaks = seq(1000,2000,200), limits = c(1000,2000))
#the upper panel
# p2<- ggplot(df, aes(TIME2, V2)) + geom_line() + labs(x=NULL) + scale_x_continuous(breaks = seq(1000,2000,200), limits = c(1000,2000)) + theme(axis.text.x=element_blank())
```

## Inclusion error & exclusion error, measured against absence of food
```{r Plots 11, echo=FALSE}
ie <- function(cutoff, var) {
  tot_in <- Gran_Anse_1 %>% filter(HDVI >= cutoff)
  tot_in_nv <- tot_in %>% filter(.data[[var]] != "Often")
  nrow(tot_in_nv) / nrow(tot_in) * 100
}

ie_pop <- function(cutoff, var) {
  sum(Gran_Anse_1$HDVI >= cutoff & Gran_Anse_1[[var]] != "Often")
}

ee <- function(cutoff, var) {
  tot_v <- Gran_Anse_1 %>% filter(.data[[var]] == "Never")
  tot_v_ex <- tot_v %>% filter(HDVI < cutoff)
  nrow(tot_v_ex) / nrow(tot_v) * 100
}

in_ex1 <- data.frame(cutoff = seq(0.1, 0.9, 0.1)) %>%
  mutate(label = paste("HDVI:", cutoff))
in_ex1$in_err <- sapply(in_ex1$cutoff, ie, var = "Absence_Food")
in_ex1$in_pop <- sapply(in_ex1$cutoff, ie_pop, var = "Absence_Food")
in_ex1$ex_err <- sapply(in_ex1$cutoff, ee, var = "Absence_Food")

ggplot(in_ex1, aes(in_err, ex_err)) +
  geom_segment(aes(xend = in_err, yend = 0), color = "grey", linetype = 3) +
  geom_text(aes(in_err, -2, label = in_pop), check_overlap = T, size = 3, color = "grey", angle = 45, hjust = "right") +
  geom_point(color = "cornflowerblue", size = 2) +
  geom_text(aes(label = cutoff), color = "cornflowerblue", nudge_x = 2, nudge_y = 0, check_overlap = T) +
  geom_text(aes(x = 40, y = 20, label = "label = HDVI cutoff"), color = "cornflowerblue") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), plot.subtitle = element_text(face = "italic", size = 9)) +
  scale_y_continuous(name = "exclusion error (%)", limits = c(-10, 100),
                     sec.axis = sec_axis(~.*sum(Gran_Anse_1$Absence_Food == "Never")/100, name = "exclusion error (population)")) +
  scale_x_continuous(name = "inclusion error (%)", position = "top",
                     sec.axis = dup_axis(name = "inclusion error (population)", labels = NULL)) +
  labs(subtitle = "* vulnerable households defined as those who often experience absence of food")

```

## Inclusion error & exclusion error, measured against restricted food consumption
```{r Plots 12, echo=FALSE}
in_ex2 <- data.frame(cutoff = seq(0.1, 0.9, 0.1)) %>%
  mutate(label = paste("HDVI:", cutoff))
in_ex2$in_err <- sapply(in_ex2$cutoff, ie, var = "Restricted_Food")
in_ex2$in_pop <- sapply(in_ex2$cutoff, ie_pop, var = "Restricted_Food")
in_ex2$ex_err <- sapply(in_ex2$cutoff, ee, var = "Restricted_Food")

ggplot(in_ex2, aes(in_err, ex_err)) +
  geom_segment(aes(xend = in_err, yend = 0), color = "grey", linetype = 3) +
  geom_text(aes(in_err, -2, label = in_pop), check_overlap = T, size = 3, color = "grey", angle = 45, hjust = "right") +
  geom_point(color = "cornflowerblue", size = 2) +
  geom_text(aes(label = cutoff), color = "cornflowerblue", nudge_x = 2, nudge_y = 0, check_overlap = T) +
  geom_text(aes(x = 40, y = 20, label = "label = HDVI cutoff"), color = "cornflowerblue") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), plot.subtitle = element_text(face = "italic", size = 9)) +
  scale_y_continuous(name = "exclusion error (%)", limits = c(-10, 100),
                     sec.axis = sec_axis(~.*sum(Gran_Anse_1$Absence_Food == "Never")/100, name = "exclusion error (population)")) +
  scale_x_continuous(name = "inclusion error (%)", position = "top",
                     sec.axis = dup_axis(name = "inclusion error (population)", labels = NULL)) +
  labs(subtitle = "* vulnerable households defined as those who often experience restricted food consumption")

```

## Inclusion error & exclusion error, measured against going to bed hungry
```{r Plots 13, echo=FALSE}
in_ex3 <- data.frame(cutoff = seq(0.1, 0.9, 0.1)) %>%
  mutate(label = paste("HDVI:", cutoff))
in_ex3$in_err <- sapply(in_ex3$cutoff, ie, var = "Bed_Hungery")
in_ex3$in_pop <- sapply(in_ex3$cutoff, ie_pop, var = "Bed_Hungery")
in_ex3$ex_err <- sapply(in_ex3$cutoff, ee, var = "Bed_Hungery")

ggplot(in_ex3, aes(in_err, ex_err)) +
  geom_segment(aes(xend = in_err, yend = 0), color = "grey", linetype = 3) +
  geom_text(aes(in_err, -2, label = in_pop), check_overlap = T, size = 3, color = "grey", angle = 45, hjust = "right") +
  geom_point(color = "cornflowerblue", size = 2) +
  geom_text(aes(label = cutoff), color = "cornflowerblue", nudge_x = 2, nudge_y = 0, check_overlap = T) +
  geom_text(aes(x = 40, y = 20, label = "label = HDVI cutoff"), color = "cornflowerblue") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), plot.subtitle = element_text(face = "italic", size = 9)) +
  scale_y_continuous(name = "exclusion error (%)", limits = c(-10, 100),
                     sec.axis = sec_axis(~.*sum(Gran_Anse_1$Absence_Food == "Never")/100, name = "exclusion error (population)")) +
  scale_x_continuous(name = "inclusion error (%)", position = "top",
                     sec.axis = dup_axis(name = "inclusion error (population)", labels = NULL)) +
  labs(subtitle = "* vulnerable households defined as those who often experience restricted food consumption")

```
